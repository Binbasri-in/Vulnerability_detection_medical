#include <iostream>
#include <fstream>
#include <vector>

#include "openfhe.h"

using namespace std;
using namespace OpenFHE;

int main() {
    // Generate keys for encryption and decryption
    KeyGen keygen;
    Key publicKey = keygen.publicKey();
    Key secretKey = keygen.secretKey();

    // Read data from the user
    cout << "Enter the data to encrypt: ";
    string inputData;
    getline(cin, inputData);

    // Convert the input string into a vector of integers
    vector<int> plaintextData;
    for (char c : inputData) {
        plaintextData.push_back(static_cast<int>(c));
    }

    // Encrypt the plaintext data
    vector<Ciphertext> ciphertextData;
    for (int num : plaintextData) {
        Ciphertext ciphertext = Encrypt(publicKey, num);
        ciphertextData.push_back(ciphertext);
    }

    // Store the encrypted data in a file
    ofstream encryptedFile("encrypted_data.txt");
    if (encryptedFile.is_open()) {
        for (const Ciphertext& ciphertext : ciphertextData) {
            encryptedFile << ciphertext << "\n";
        }
        encryptedFile.close();
        cout << "Data encrypted and stored in 'encrypted_data.txt'." << endl;
    } else {
        cout << "Failed to open the file for writing." << endl;
        return 1;
    }

    // Later, when necessary, load the encrypted data from the file
    ifstream encryptedFileRead("encrypted_data.txt");
    if (encryptedFileRead.is_open()) {
        vector<Ciphertext> loadedCiphertextData;
        Ciphertext ciphertext;
        while (encryptedFileRead >> ciphertext) {
            loadedCiphertextData.push_back(ciphertext);
        }
        encryptedFileRead.close();

        // Decrypt the loaded ciphertext data using the secret key
        vector<int> decryptedData;
        for (const Ciphertext& ciphertext : loadedCiphertextData) {
            int decryptedValue = Decrypt(secretKey, ciphertext);
            decryptedData.push_back(decryptedValue);
        }

        // Convert the decrypted data back into a string
        string decryptedString;
        for (int num : decryptedData) {
            decryptedString += static_cast<char>(num);
        }

        cout << "Decrypted data: " << decryptedString << endl;
    } else {
        cout << "Failed to open the file for reading." << endl;
        return 1;
    }

    return 0;
}